name: Build and Test
on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11
      - name: Cache Maven packages
        uses: actions/cache@v1
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
      - name: Build
        #if: 0
        run: mvn -B install -DskipTests
      - name: Install PostgreSQL
        run: |
          sudo useradd ctsms -p '*' --groups sudo
          sudo apt-get update
          sudo apt-get install --yes postgresql
          sudo service postgresql start
      - name: Generate DB schema
        #if: 0
        run: mvn -f core/pom.xml org.andromda.maven.plugins:andromdapp-maven-plugin:schema -Dtasks=create
      - name: Create DB schema
        #if: 0
        run: |
          sudo -u postgres psql postgres -c "CREATE USER ctsms WITH PASSWORD 'ctsms';"
          sudo -u postgres psql postgres -c "CREATE DATABASE ctsms;"
          sudo -u postgres psql postgres -c "GRANT ALL PRIVILEGES ON DATABASE ctsms to ctsms;"
          sudo -u ctsms psql -U ctsms ctsms < /home/runner/work/ctsms/ctsms/core/db/schema-create.sql
          sudo -u ctsms psql -U ctsms ctsms < /home/runner/work/ctsms/ctsms/core/db/index-create.sql
      - name: Init DB
        run: |
          mkdir /ctsms
          chown ctsms:ctsms /ctsms -R
          chown ctsms:ctsms /home/runner/work/ctsms/ctsms/.github/workflows/dbtool.sh
          sudo chmod 755 /home/runner/work/ctsms/ctsms/.github/workflows/dbtool.sh
          sudo -u ctsms /home/runner/work/ctsms/ctsms/.github/workflows/dbtool.sh -i -f
